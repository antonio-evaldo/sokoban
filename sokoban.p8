pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
function _init()
  win = false
  game_over = false

  sprites = {
    wall = 1,
    box = 2,
    goal = 3,
    water = 4,
    player = 16,
    pieces = {
      criar = { 64, 65 },
      po = 66,
      n = 67,
      te = 68
    },
    words = {
      ponte = {
        pieces = { 66, 67, 68 }
      }
    }
  }

  level = 2

  make_player()
  make_boxes()
  make_map()
end

function _update()
  if not win and not game_over then
    move_player_and_boxes()
    check_win()
  end
end

function _draw()
  cls()

  draw_map()
  draw_player()
  draw_boxes()

  if win then
    print('you won!', 50, 10)
  elseif game_over then
    print('you lost.', 50, 10)
  end
end
-->8
function make_player()
  player = {
    x = nil,
    y = nil,
    sprite = sprites.player
  }
end

function make_boxes()
  boxes = {}
end

function move_player_and_boxes()
  local move = { x = 0, y = 0 }

  if (btnp(0)) move.x = -8
  if (btnp(1)) move.x = 8
  if (btnp(2)) move.y = -8
  if (btnp(3)) move.y = 8
  local newplayerpos = {
    x = player.x + move.x,
    y = player.y + move.y
  }

  if collinding_wall(newplayerpos) then return end

  if collinding_water(newplayerpos) then game_over = true end

  if not collinding_box(newplayerpos) then
    player.x += move.x
    player.y += move.y
  end

  if collinding_box(newplayerpos) then
    local box_id = get_collinding_box(newplayerpos)

    local newboxpos = {
      x = newplayerpos.x + move.x,
      y = newplayerpos.y + move.y
    }

    if not collinding_wall(newboxpos) then
      player.x += move.x
      player.y += move.y

      boxes[box_id].x += move.x
      boxes[box_id].y += move.y
    end
    -- and can_move(newplayerpos, move)
  end
end

function can_move(point, move)
  return true
  -- return collinding_nothing(box.x + move.x, box.y + move.y)
  -- return not collinding_wall(box.x + move.x, box.y + move.y)
  -- return false
end

function collinding_nothing(point)
  return mget_coord(point.x, point.y) == 0
end

function collinding_wall(point)
  return mget_coord(point.x, point.y) == sprites.wall
end

function collinding_water(point)
  return mget_coord(point.x, point.y) == sprites.water
end

function collinding_box(point)
  for box in all(boxes) do
    if (point.x == box.x and point.y == box.y) return true
  end
end

function get_collinding_box(point)
  for box in all(boxes) do
    if (point.x == box.x and point.y == box.y) return box.id
  end
end

function check_win()
  -- if mget_coord(box.x, box.y) == sprites.goal then
  --   win = true
  -- end
end

function draw_player()
  spr(player.sprite, player.x, player.y)
end

function draw_boxes()
  for box in all(boxes) do
    spr(sprites.box, box.x, box.y)
  end
end
-->8
function make_map()
  local box_id = 1

  for x = 0, 15 do
    for y = 0, 15 do
      if mget_in_level(x, y) == player.sprite then
        player.x = x * 8
        player.y = y * 8
        mset_in_level(x, y, 0) -- remove player from static map
      elseif mget_in_level(x, y) == sprites.box then
        add(boxes, { id = box_id, x = x * 8, y = y * 8 })

        box_id += 1

        mset_in_level(x, y, 0) -- remove box from static map
      end
    end
  end
end

function mget_coord(x, y)
  return mget_in_level(x / 8, y / 8)
end

function mget_in_level(x, y)
  return mget(x + (level - 1) * 16, y)
end

function mset_in_level(x, y)
  return mset(x + (level - 1) * 16, y)
end

function draw_map()
  local map_tx = (level - 1) * 16
  map(map_tx, 0)
end
__gfx__
0000000077777777000aa000cccccccc0cccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007777777700aaaa00c000000ccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777770aaaaaa0c000000ccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700077777777aaaaaaaac000000ccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700077777777aaaaaaaac000000ccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777770aaaaaa0c000000ccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007777777700aaaa00c000000ccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000077777777000aa000cccccccc0cccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88088088000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11011011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11011011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99099909099909990999099900099000099909990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90090909090909090909090900090900009009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90099009099909900999090900090900009009900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99090909090909090900090900090900009009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000900099900090900009009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000400000000000000000000000000000101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000400000000000000000000000000000100000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010101010000000000000000000040410000000000000400000000000001010101010101010100000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010003010000000000000000000000000000430000000400000000000001000001000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010000010000000000000000000000000000420000000400000000000001000201030000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010010010101000000000000000000000000440000000400000300000001000001010101010101000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010000000001000000000000000001000000000000000000000000000001000000000000010101000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010000020001000000000000000001000002001000000400000000000001010000000000000001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010000010101000000000000000001000002000000000400000000000001010000010100010001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010000010000000000000000000000000000000000000400000000000001001000010000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010101010000000000000000000000000000000000000400000000000001000000010000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000400000000000001010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
